{% extends 'base.html.twig' %}

{% block title %}Tutoriels{% endblock %}

{% block body %}
    <h1 id="TutoViewTitre">{{ tutorial.title }}</h1>
    <div class="row">
        <div class="column"> 
            <h4 id="TutoViewAuthor" > Author : {{ tutorial.author }}</h4>
            <p class="TutoViewdate" > Created at : {{ tutorial.createdAt|date("d/m/Y") }}</p>
        </div>


        <p class="LikeButton" > Do you like this tutorial ? 
            <a href="{{ path('tutorial_post_like',{'id' : tutorial.id}) }}" class="btn btn-link js-like">
            {% if app.user and tutorial.isLikedByUser(app.user) %}
                <i class="fas fa-thumbs-up"></i>
            {% else %}
                <i class="far fa-thumbs-up"></i>
            {% endif %}
                <span class="js-likes">{{ tutorial.seeLikes | length }}</span>
                <span class="js-label">J'aime</span>
            </a> 
        </p>

    </div>
   
    {% if tutorial.editedAt != null %}
        <p class="TutoViewdate2" > Last update : {{ tutorial.editedAt|date("d/m/Y")}}</p>
    {% endif %}
    <section class="TutoViewSection"> 

        {% apply markdown_to_html %}
            {{ tutorial.content }}     
        {% endapply %}
    </section>

    <div class="elementCase playQuiz">
        <h3>Testez votre compréhension du tutoriel</h3>
        {% if app.user %}
        <a href="{{ path('tutorial_play_quiz', {'id': tutorial.id}) }}">Répondre aux questions du Quiz!</a>
        {% else %}
        <p>Vous devez vous connecter pour répondre au quiz: <a href="{{ path('app_login') }}">Se connecter</a><p>
        {% endif %}
    </div>

    {#-----------------AJAX-----------#}
    {% block javascripts %}
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>

        function onClickBtnLike(event){
            event.preventDefault(); //on empêche de faire une redirection (action par défaut)
            const url = this.href; //le this représente l'élément qui déclenche l'évenement
            //à savoir, ici, this correspond à notre balise <a>
            
            const spanCount = this.querySelector('span.js-likes');
            //récupère le span ayant pour classe 'js-likes' se trouvant dans 'this' (notre balise <a>)
            
            const icone = this.querySelector('i');

            axios.get(url).then(function(response){
                spanCount.textContent = response.data.seeLikes
                // si on console log la 'response', on peut voir le chemin:
                // response > data > likes     

                //traitement se faisant car le nom des icons changent si c'est 'far' ou 'fas'
                if(icone.classList.contains('fas')) 
                {
                    icone.classList.replace('fas', 'far') 
                }
                else
                {
                    icone.classList.replace('far', 'fas');
                }      
            }).catch(function(error){
                //S'il y a une erreur 403 (dans le cas où on n'est pas connecté)
                if(error.response.status === 403){
                    window.alert("Vous ne pouvez pas liker un article si vous n'êtes pas connecté!")
                }
                //Une autre erreur
                else
                {
                    window.alert("Une erreur s'est produite");
                }
            });
        }

        document.querySelectorAll('a.js-like').forEach(function(link)
        {
            link.addEventListener('click', onClickBtnLike);
            //quand on clique sur une balise <a> ayant pour classe 'js-like'
            // alors on appelle la fonction onClickBtnLike
        })
    </script>
    {% endblock %}
    {#-----------------FIN AJAX-----------#}

    
{% endblock %}